<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•ä Arena Voxel 3D - TikTok Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
        body { margin: 0; font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); } ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 10px; }
        .glass-panel { background: rgba(15, 25, 40, 0.5); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); color: white; }
        .fighter-name { text-shadow: 3px 3px 6px rgba(0,0,0,0.9); }
        @keyframes glowPulse { 0% { text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700; transform: scale(1); } 50% { text-shadow: 0 0 20px #FFD700, 0 0 40px #FFA500; transform: scale(1.1); } 100% { text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700; transform: scale(1); } }
        .winner-text { animation: glowPulse 1.5s infinite; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
        .float-text { animation: floatUp 1.5s ease-out forwards; position: absolute; pointer-events: none; font-weight: 900; text-shadow: 2px 2px 4px #000; z-index: 50; }
    </style>
</head>
<body class="w-screen h-screen relative text-sm md:text-base">

    <!-- Kontainer 3D Canvas -->
    <div id="canvas-container" class="absolute inset-0 z-0"></div>

    <!-- UI Overlay Utama -->
    <div class="absolute inset-0 z-10 pointer-events-none">
        
        <div class="absolute top-4 left-1/2 transform -translate-x-1/2 w-11/12 md:w-auto text-center pointer-events-auto">
            <div id="arena-status" class="glass-panel px-6 py-2 md:py-3 rounded-full font-black text-sm md:text-lg text-green-400 shadow-xl border-t border-white/20 transition-all duration-300">
                üü¢ Arena Menunggu Penantang
            </div>
            <div id="tiktok-status" class="mt-2 inline-block text-[10px] md:text-xs font-bold text-gray-400 bg-black/40 px-4 py-1 rounded-full border border-transparent">
                üéµ Menunggu Koneksi dari Operator...
            </div>
        </div>

        <button id="btn-audio" onclick="initAudio()" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-yellow-500 hover:bg-yellow-400 text-black font-black px-6 py-2 rounded-full shadow-[0_0_15px_rgba(234,179,8,0.5)] pointer-events-auto transition-all animate-bounce">üîä Aktifkan Suara</button>

        <!-- KIRI: Leaderboard -->
        <div class="absolute left-2 md:left-4 top-20 md:top-24 bottom-4 w-44 md:w-64 flex flex-col pointer-events-auto transition-all">
            <div class="glass-panel rounded-2xl p-3 md:p-4 h-full flex flex-col">
                <h2 class="text-sm md:text-xl font-black mb-2 flex items-center gap-2 text-yellow-300">üèÜ Top Rank</h2>
                <div id="leaderboard" class="flex flex-col gap-2 overflow-y-auto pr-1 flex-1 pb-2"></div>
            </div>
        </div>

        <!-- KANAN: Antrean & Riwayat -->
        <div class="absolute right-2 md:right-4 top-20 md:top-24 bottom-4 w-44 md:w-64 flex flex-col gap-2 md:gap-3 pointer-events-auto transition-all">
            
            <div class="glass-panel rounded-2xl p-2 md:p-3 flex flex-col h-[40%] border-t-2 border-orange-500">
                <h2 class="text-xs md:text-base font-black mb-1 flex items-center gap-1.5 text-orange-400">‚è≥ Antrean Penantang</h2>
                <div id="queue-board" class="flex flex-col overflow-y-auto pr-1 flex-1 gap-1"><div class="text-gray-400 text-[10px] md:text-xs italic text-center mt-2">Antrean kosong.</div></div>
            </div>

            <div class="glass-panel rounded-2xl p-2 md:p-3 flex flex-col h-[60%] border-t-2 border-red-500">
                <h2 class="text-xs md:text-base font-black mb-1 flex items-center gap-1.5 text-red-400">ü•ä Riwayat K.O</h2>
                <p id="target-info-text" class="text-gray-400 text-[8px] md:text-[10px] mb-2 border-b border-gray-600 pb-2">Membaca Aturan Server...</p>
                <div id="history-board" class="flex flex-col gap-2 overflow-y-auto pr-1 flex-1 pb-2"></div>
            </div>
        </div>

    </div>

    <!-- Layar Pemenang K.O -->
    <div id="winner-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center hidden bg-black/80 backdrop-blur-sm pointer-events-none transition-opacity duration-500 opacity-0">
        <div class="text-center transform scale-110">
            <h1 class="text-6xl md:text-8xl font-black text-red-500 winner-text mb-4 uppercase tracking-widest text-shadow-lg">K . O !</h1>
            <div class="text-xl md:text-2xl text-white font-bold mb-4">RAJA ARENA SAAT INI:</div>
            <div id="winner-name" class="text-4xl md:text-6xl font-black text-white bg-gradient-to-r from-yellow-500 to-orange-600 px-12 py-5 rounded-full shadow-[0_0_50px_rgba(255,215,0,0.5)] border-4 border-white">NAMA</div>
        </div>
    </div>

    <!-- Wadah untuk Floating Text (Heal) -->
    <div id="floating-text-container" class="absolute inset-0 z-40 pointer-events-none overflow-hidden"></div>

    <script>
        // ==========================================
        // PENGATURAN DINAMIS (DIKENDALIKAN SERVER)
        // ==========================================
        let CONFIG = { targetGifts: 5, targetLikes: 30, likesForOneHp: 5, damagePower: 1 };
        
        // --- NEW: KICK AFK SETTING ---
        const IDLE_TIMEOUT_SECONDS = 10; // Kick penonton jika tidak tap/like dalam 10 detik
        const MAX_AUDIENCE = 30; // Maksimal karakter yang tampil di tribun

        // --- AUDIO ---
        let audioCtx; let isAudioEnabled = false;
        function initAudio() { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); isAudioEnabled = true; document.getElementById('btn-audio').style.display = 'none'; }
        function playBellSound() { if (!isAudioEnabled || !audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 1.5); gain.gain.setValueAtTime(1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 1.5); }
        function playPunchSound() { if (!isAudioEnabled || !audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'square'; osc.frequency.setValueAtTime(150, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
        function playWinFanfare() { if (!isAudioEnabled || !audioCtx) return; const notes = [523.25, 659.25, 783.99, 1046.50]; notes.forEach((freq, i) => { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'triangle'; osc.frequency.value = freq; gain.gain.setValueAtTime(0, audioCtx.currentTime + i*0.15); gain.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + i*0.15 + 0.05); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i*0.15 + 0.6); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(audioCtx.currentTime + i*0.15); osc.stop(audioCtx.currentTime + i*0.15 + 0.6); }); }
        
        let lastLikeAudioTime = 0;
        function playTikTokAlert(isLike = false) { 
            if (!isAudioEnabled || !audioCtx || audioCtx.state !== 'running') return; 
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(isLike ? 400 : 600, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(isLike ? 800 : 1200, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(isLike ? 0.2 : 0.5, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (isLike ? 0.3 : 0.5)); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.5); 
        }
        function playHealSound() { if (!isAudioEnabled || !audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(800, audioCtx.currentTime + 0.3); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.3); }

        // --- GAME DATA ---
        const STORAGE_KEY = 'voxel_users_data';
        const HISTORY_KEY = 'voxel_fight_history';
        const SPONSOR_KEY = 'voxel_sponsors_data'; 
        const RANKS = [ { minGifts: 0, title: "Warga", color: 0x8BC34A, tier: 1 }, { minGifts: 100, title: "Ksatria", color: 0x03A9F4, tier: 2 }, { minGifts: 1000, title: "Bangsawan", color: 0xFF9800, tier: 3 }, { minGifts: 5000, title: "Kaisar", color: 0xFFEB3B, tier: 4 }, { minGifts: 10000, title: "Dewa", color: 0x9C27B0, tier: 5 } ];

        // STATE UTAMA (In-Memory Processing for High Performance)
        let usersData = {}; 
        let characterMeshes = {}; 
        let fightQueue = []; 
        let isDataDirty = false; 
        let lastRawData = "{}";
        
        let isFighting = false; 
        let currentKing = null; 
        let fighterA = null; 
        let fighterB = null; 
        let hpA = 100; let hpB = 100; const MAX_HP = 100;

        let fightPhase = 0; let fightTimer = 0; let matchWinner = null; let matchLoser = null;
        let targetCamPos = new THREE.Vector3(0, 10, 14); let targetLookAt = new THREE.Vector3(0, 0, 0); let currentLookAt = new THREE.Vector3(0, 0, 0);
        let particles = []; 
        let ambientLightMain, spotLightA, spotLightB;

        function getRank(gifts) { let currentRank = RANKS[0]; for (let i = 0; i < RANKS.length; i++) { if (gifts >= RANKS[i].minGifts) currentRank = RANKS[i]; } return currentRank; }
        function setArenaStatus(text, colorClass) { const statusEl = document.getElementById('arena-status'); statusEl.innerText = text; statusEl.className = `glass-panel px-6 py-2 md:py-3 rounded-full font-black text-sm md:text-lg shadow-xl border-t border-white/20 transition-all duration-300 ${colorClass}`; }
        
        // --- TIKTOK SOCKET ---
        let socket;
        function initSocketListener() {
            try {
                socket = io();
                socket.on('tiktok-status', (data) => { const statusBtn = document.getElementById('tiktok-status'); if(data.connected) { statusBtn.innerText = `üéµ Live: @${data.username}`; statusBtn.classList.replace('text-gray-400', 'text-cyan-300'); statusBtn.classList.replace('text-red-400', 'text-cyan-300'); statusBtn.classList.replace('bg-black/40', 'bg-cyan-900/50'); statusBtn.classList.replace('bg-red-900/50', 'bg-cyan-900/50'); statusBtn.classList.add('border-cyan-500'); } else { statusBtn.innerText = "üéµ TikTok: Menunggu Operator"; statusBtn.classList.replace('text-cyan-300', 'text-gray-400'); statusBtn.classList.replace('bg-cyan-900/50', 'bg-black/40'); statusBtn.classList.remove('border-cyan-500'); } });
                socket.on('tiktok-join', (data) => { processJoin(data.username); }); 
                socket.on('tiktok-gift', (data) => { processDonation(data.username, data.amount, 'gift'); }); 
                socket.on('tiktok-like', (data) => { processDonation(data.username, data.amount, 'like'); });
                socket.on('disconnect', () => { const statusBtn = document.getElementById('tiktok-status'); statusBtn.innerText = "üéµ Server Terputus"; statusBtn.classList.replace('text-cyan-300', 'text-red-400'); statusBtn.classList.replace('bg-cyan-900/50', 'bg-red-900/50'); });
                
                // MENERIMA CONFIG MEKANIK DARI BACKEND SECARA REAL-TIME
                socket.on('config-update', (newConfig) => {
                    CONFIG = newConfig;
                    const infoEl = document.getElementById('target-info-text');
                    if(infoEl) infoEl.innerText = `1 Tiket = ${CONFIG.targetGifts} Mawar ATAU ${CONFIG.targetLikes} Tap`;
                    
                    // Segarkan 3D Papan Nama
                    for(let name in characterMeshes) {
                        const ud = characterMeshes[name].userData;
                        updateNameTag(ud.nameSprite, name, usersData[name]?.gifts || 0, usersData[name]?.likes || 0);
                    }
                    if(!isFighting) checkFightQueue();
                });
            } catch (error) { console.log("Menjalankan mode lokal tanpa server node.js"); }
        }

        function showFloatingText(name, text, colorClass) {
            const container = document.getElementById('floating-text-container');
            const el = document.createElement('div');
            el.className = `float-text text-xl md:text-3xl ${colorClass}`;
            el.innerText = text;
            if(name === fighterA) { el.style.left = '30%'; el.style.top = '40%'; }
            else if(name === fighterB) { el.style.left = '70%'; el.style.top = '40%'; }
            else return; 
            
            container.appendChild(el);
            setTimeout(() => { if(el.parentNode) el.parentNode.removeChild(el); }, 1500);
        }

        // ==============================================================
        // SISTEM ANTI-MACET (Data diolah di memori, disimpan bertahap)
        // ==============================================================
        function processJoin(name) {
            if (!usersData[name]) { 
                usersData[name] = { gifts: 0, likes: 0, fights: 0, lastActive: Date.now() }; 
                setArenaStatus(`üëã ${name} memasuki arena!`, "text-white bg-blue-900/50 border-blue-500 scale-105"); 
            } 
            usersData[name].lastActive = Date.now(); 
            isDataDirty = true; 
        }

        function processDonation(name, amount, type) {
            let isNewUser = false;
            if (!usersData[name]) { 
                usersData[name] = { gifts: 0, likes: 0, fights: 0, lastActive: Date.now() }; 
                isNewUser = true;
            }
            
            // Logika Tambah HP (Realtime Heal)
            if (isFighting && (name === fighterA || name === fighterB)) {
                let healAmount = 0;
                let lForHp = Math.max(1, CONFIG.likesForOneHp);
                if (type === 'gift') { healAmount = amount * 10; } 
                else if (type === 'like' && CONFIG.likesForOneHp > 0) { healAmount = Math.floor(amount / lForHp); }

                if (healAmount > 0) {
                    if (name === fighterA) hpA = Math.min(MAX_HP, hpA + healAmount);
                    if (name === fighterB) hpB = Math.min(MAX_HP, hpB + healAmount);
                    playHealSound(); 
                    showFloatingText(name, `+${healAmount} HP`, 'text-green-400');
                }
            }

            if (type === 'gift') { 
                usersData[name].gifts += amount; 
                playTikTokAlert(false); 
                setArenaStatus(`üåπ TikTok: ${name} mengirim ${amount} Mawar!`, "text-cyan-400 bg-cyan-900/50 border-cyan-500 scale-105"); 
            } 
            else if (type === 'like') { 
                usersData[name].likes += amount; 
                const now = Date.now();
                if (now - lastLikeAudioTime > 400) { playTikTokAlert(true); lastLikeAudioTime = now; }
            }
            
            // PERBARUI WAKTU AKTIF UNTUK MENCEGAH KICK AFK
            usersData[name].lastActive = Date.now(); 

            // Update Papan Nama 3D secara instan agar memuaskan penonton
            if (characterMeshes[name]) {
                updateNameTag(characterMeshes[name].userData.nameSprite, name, usersData[name].gifts, usersData[name].likes);
            } else if (isNewUser) {
                isDataDirty = true; // Akan dibuat pada render berikutnya
            }

            isDataDirty = true; 
        }

        // ==============================================================
        // NEW: SISTEM KICK AFK (Pembersihan Otomatis)
        // ==============================================================
        function cleanupIdleUsers() {
            let isChanged = false; 
            const now = Date.now(); 
            const timeoutMs = IDLE_TIMEOUT_SECONDS * 1000; // 10 Detik sesuai setting

            for (const name in usersData) {
                // JANGAN kick jika dia sedang bertarung atau dia adalah Raja!
                if (name === fighterA || name === fighterB || name === currentKing) continue;
                
                // JANGAN kick jika dia sedang dalam antrean
                if (fightQueue.includes(name)) continue;

                if (!usersData[name].lastActive) { 
                    usersData[name].lastActive = now; 
                    isChanged = true; 
                } 
                else if (now - usersData[name].lastActive > timeoutMs) { 
                    // USER AFK SELAMA 10 DETIK -> KICK!
                    delete usersData[name]; 
                    if(characterMeshes[name]) { 
                        scene.remove(characterMeshes[name]); 
                        delete characterMeshes[name]; 
                    }
                    isChanged = true; 
                }
            }
            if (isChanged) isDataDirty = true;
        }

        // ==============================================================
        // SINKRONISASI UPDATE UI & STORAGE (MENCEGAH BROWSER FREEZE)
        // ==============================================================
        function runSyncLoop() {
            if (isDataDirty) {
                lastRawData = JSON.stringify(usersData);
                localStorage.setItem(STORAGE_KEY, lastRawData);
                isDataDirty = false;
                
                updateUI(); 
                checkFightQueue(); 
                updateAudiencePositions(); 
            } else {
                // Deteksi perubahan dari Panel Operator secara paksa
                const rawData = localStorage.getItem(STORAGE_KEY) || '{}';
                if (rawData !== lastRawData) {
                    usersData = JSON.parse(rawData);
                    lastRawData = rawData;
                    if (Object.keys(usersData).length === 0) { fightQueue = []; currentKing = null; } 
                    
                    updateUI(); 
                    if (!isFighting) checkFightQueue(); 
                    updateAudiencePositions();
                    
                    // Segarkan tulisan papan nama 3D jika diubah manual dari operator
                    for(let name in characterMeshes) {
                        if(usersData[name]) updateNameTag(characterMeshes[name].userData.nameSprite, name, usersData[name].gifts, usersData[name].likes);
                    }
                }
            }
        }

        function updateUI() {
            const uiLeaderboard = document.getElementById('leaderboard');
            const sortedUsers = Object.entries(usersData).sort((a, b) => { let scoreA = (a[1].gifts || 0) * 100 + (a[1].likes || 0); let scoreB = (b[1].gifts || 0) * 100 + (b[1].likes || 0); return scoreB - scoreA; });
            let htmlStr = '';
            sortedUsers.slice(0, 30).forEach((user, index) => {
                const name = user[0]; const gifts = user[1].gifts || 0; const likes = user[1].likes || 0; const rank = getRank(gifts); let medal = `#${index + 1}`; if (index === 0) medal = 'ü•á'; else if (index === 1) medal = 'ü•à'; else if (index === 2) medal = 'ü•â';
                const isKingMark = name === currentKing ? 'üëë ' : '';
                htmlStr += `<div class="flex items-center justify-between p-1.5 md:p-2 rounded-lg bg-white/5 border ${name===currentKing?'border-yellow-500':'border-white/10'} text-[10px] md:text-sm"><div class="flex items-center gap-1.5 md:gap-2 overflow-hidden"><span class="font-black w-4 md:w-5 text-center text-white text-[10px] md:text-xs">${medal}</span><div class="truncate"><div class="font-bold text-white truncate text-[10px] md:text-xs">${isKingMark}${name}</div><div class="text-[8px] md:text-[10px] font-bold" style="color: #${rank.color.toString(16).padStart(6,'0')}">${rank.title}</div></div></div><div class="font-black text-right ml-1"><div class="text-pink-400 text-[10px] md:text-xs">${gifts > 999 ? (gifts/1000).toFixed(1) + 'k' : gifts} üåπ</div><div class="text-red-400 text-[8px] md:text-[10px]">${likes > 999 ? (likes/1000).toFixed(1) + 'k' : likes} ‚ù§Ô∏è</div></div></div>`;
            });
            uiLeaderboard.innerHTML = htmlStr;

            const uiHistory = document.getElementById('history-board'); const historyData = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); 
            let histStr = '';
            if(historyData.length === 0) { histStr = '<div class="text-gray-400 text-[10px] md:text-xs italic text-center mt-2">Belum ada.</div>'; } 
            else { [...historyData].reverse().slice(0, 15).forEach(hist => { histStr += `<div class="p-1.5 md:p-2 rounded-lg bg-black/40 border border-red-500/20 text-[10px] md:text-xs"><div class="flex justify-between items-center mb-0.5 md:mb-1"><span class="font-black text-green-400 truncate w-16 md:w-24">üëë ${hist.winner}</span><span class="text-[8px] md:text-[10px] text-gray-500">${hist.time}</span></div><div class="text-gray-400 text-[8px] md:text-[10px]">KO <span class="text-red-400 font-bold ml-1">${hist.loser}</span></div></div>`; }); }
            uiHistory.innerHTML = histStr;
        }

        function updateQueueUI() {
            const queueBoard = document.getElementById('queue-board'); 
            let html = '';
            if (currentKing && !isFighting) {
                html += `<div class="p-1.5 md:p-2 rounded-lg bg-yellow-900/50 border border-yellow-500 text-[10px] md:text-xs text-center flex justify-between items-center px-2 mb-1 shadow-[0_0_10px_rgba(234,179,8,0.3)]"><span class="font-bold text-yellow-400 truncate w-[35%] text-left">üëë ${currentKing}</span> <span class="text-yellow-500 font-black text-[8px] md:text-[10px] w-[20%]">VS</span> <span class="font-bold text-gray-400 truncate w-[35%] text-right">Menunggu...</span></div>`;
            }

            if (fightQueue.length === 0 && !currentKing) { 
                queueBoard.innerHTML = '<div class="text-gray-400 text-[10px] md:text-xs italic text-center mt-2">Antrean kosong.</div>'; 
                return; 
            }
            
            let tempQ = [...fightQueue];
            let renderLimit = 0;
            
            while(tempQ.length > 0 && renderLimit < 15) {
                let p1 = tempQ.shift(); let p2Index = tempQ.findIndex(x => x !== p1); let p2 = '???';
                if(p2Index !== -1) { p2 = tempQ[p2Index]; tempQ.splice(p2Index, 1); } 
                html += `<div class="p-1.5 md:p-2 rounded-lg bg-black/50 border border-orange-500/50 text-[10px] md:text-xs text-center flex justify-between items-center px-2 mb-1"><span class="font-bold text-blue-400 truncate w-[35%] text-left">${p1}</span> <span class="text-yellow-500 font-black text-[8px] md:text-[10px] w-[20%]">VS</span> <span class="font-bold ${p2.includes('???') ? 'text-gray-500' : 'text-red-400'} truncate w-[35%] text-right">${p2}</span></div>`;
                renderLimit++;
            }
            if (tempQ.length > 0) {
                html += `<div class="text-gray-400 text-[10px] italic text-center mt-1">+ ${tempQ.length} antrean lainnya...</div>`;
            }
            
            queueBoard.innerHTML = html;
        }

        function checkFightQueue() {
            fightQueue = []; 
            let tGifts = Math.max(1, CONFIG.targetGifts); 
            let tLikes = Math.max(1, CONFIG.targetLikes); 

            for (const [name, data] of Object.entries(usersData)) {
                const ticketsFromGifts = Math.floor((data.gifts || 0) / tGifts); 
                const ticketsFromLikes = Math.floor((data.likes || 0) / tLikes);
                
                const totalTickets = ticketsFromGifts + ticketsFromLikes; const fightsDone = data.fights || 0;
                let availableTickets = totalTickets - fightsDone; 
                if (name === currentKing && !isFighting) availableTickets--;
                
                // Mencegah memory crash (Limit maksimum 50 tiket divisualkan per user)
                const pushLimit = Math.min(50, Math.max(0, availableTickets));
                for(let i = 0; i < pushLimit; i++) { fightQueue.push(name); }
            }
            
            updateQueueUI();

            if (!isFighting) {
                if (currentKing) {
                    let challengerIdx = fightQueue.findIndex(n => n !== currentKing);
                    if (challengerIdx !== -1) {
                        let challenger = fightQueue[challengerIdx];
                        fightQueue.splice(challengerIdx, 1);
                        startFight(currentKing, challenger); 
                    }
                } 
                else if (fightQueue.length >= 2) {
                    let fA = fightQueue[0]; let fB = null; let idxB = -1;
                    for(let i = 1; i < fightQueue.length; i++) { if(fightQueue[i] !== fA) { fB = fightQueue[i]; idxB = i; break; } }
                    if (fB !== null) { 
                        fightQueue.splice(idxB, 1); fightQueue.splice(0, 1); startFight(fA, fB); 
                    } 
                }
            }
        }

        function updateHUD() {
            if(isFighting) {
                if(characterMeshes[fighterA]) {
                    updateNameTag(characterMeshes[fighterA].userData.nameSprite, fighterA, usersData[fighterA]?.gifts || 0, usersData[fighterA]?.likes || 0);
                }
                if(characterMeshes[fighterB]) {
                    updateNameTag(characterMeshes[fighterB].userData.nameSprite, fighterB, usersData[fighterB]?.gifts || 0, usersData[fighterB]?.likes || 0);
                }
            }
        }

        function startFight(fA, fB) {
            isFighting = true; fighterA = fA; fighterB = fB;
            hpA = MAX_HP; hpB = MAX_HP; 

            if(fA !== currentKing) { usersData[fA].fights = (usersData[fA].fights || 0) + 1; } 
            usersData[fB].fights = (usersData[fB].fights || 0) + 1; 
            isDataDirty = true; 

            updateQueueUI();
            
            // Papan nama pastikan langsung terupdate HP-nya
            if(characterMeshes[fighterA]) updateNameTag(characterMeshes[fighterA].userData.nameSprite, fighterA, usersData[fighterA].gifts, usersData[fighterA].likes);
            if(characterMeshes[fighterB]) updateNameTag(characterMeshes[fighterB].userData.nameSprite, fighterB, usersData[fighterB].gifts, usersData[fighterB].likes);

            fightPhase = 0; fightTimer = 0;
            if(ambientLightMain) ambientLightMain.intensity = 0.5; 
            if(spotLightA) spotLightA.intensity = 5; 
            if(spotLightB) spotLightB.intensity = 5;

            setArenaStatus(`ü•ä BERTARUNG: ${fighterA} vs ${fighterB}`, "text-red-400 bg-red-900/50 border-red-500"); 
            playBellSound();
        }

        function createHitSparks(position) {
            const particleCount = 10;
            for(let i=0; i<particleCount; i++) {
                const geo = new THREE.BoxGeometry(0.15, 0.15, 0.15);
                const mat = new THREE.MeshBasicMaterial({color: 0xffdd00});
                const p = new THREE.Mesh(geo, mat);
                p.position.copy(position);
                p.position.y += 1.2; 
                
                p.userData = {
                    vx: (Math.random() - 0.5) * 0.4,
                    vy: Math.random() * 0.4,
                    vz: (Math.random() - 0.5) * 0.4,
                    life: 1.0
                };
                scene.add(p);
                particles.push(p);
            }
        }

        function processMatchResult() {
            fightPhase = 2; fightTimer = 0;
            
            if (hpA > hpB) { matchWinner = fighterA; matchLoser = fighterB; } 
            else if (hpB > hpA) { matchWinner = fighterB; matchLoser = fighterA; }
            else {
                if (Math.random() > 0.5) { matchWinner = fighterA; matchLoser = fighterB; } else { matchWinner = fighterB; matchLoser = fighterA; }
            }

            currentKing = matchWinner;
            
            if(ambientLightMain) ambientLightMain.intensity = 1.5; 
            if(spotLightA) spotLightA.intensity = 0; 
            if(spotLightB) spotLightB.intensity = 0;

            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); const timeStr = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            history.push({ winner: matchWinner, loser: matchLoser, time: timeStr }); 
            if (history.length > 15) history.shift();
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); 
            
            const winnerOverlay = document.getElementById('winner-overlay'); 
            document.getElementById('winner-name').innerText = matchWinner; 
            winnerOverlay.classList.remove('hidden'); 
            
            playWinFanfare(); 
            setArenaStatus(`üèÜ RAJA BARU: ${matchWinner} !`, "text-yellow-400 bg-yellow-900/50 border-yellow-500");

            isDataDirty = true; // Simpan data pasca menang
        }

        // --- THREE.JS INITIALIZATION WITH SPONSORS ---
        let scene, camera, renderer;
        let sponsorMaterials = {}; 

        window.onload = function() {
            initSocketListener(); init3D(); 
            
            lastRawData = localStorage.getItem(STORAGE_KEY) || '{}';
            usersData = JSON.parse(lastRawData);
            updateUI(); checkFightQueue(); updateAudiencePositions();
            
            // Loop Sinkronisasi & AFK Kick 
            setInterval(runSyncLoop, 1000); 
            setInterval(cleanupIdleUsers, 2000); // Cek user afk setiap 2 detik
            
            window.addEventListener('storage', (e) => { 
                if (e.key === SPONSOR_KEY) {
                    updateSponsorTextures(); 
                }
            });
            window.addEventListener('resize', onWindowResize, false); 
            animate();
        };

        function init3D() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene(); scene.fog = new THREE.Fog(0x0f2027, 10, 45);
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 10, 14); currentLookAt.set(0, 0, 0); camera.lookAt(currentLookAt);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true; renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            ambientLightMain = new THREE.AmbientLight(0x404040, 1.5);
            scene.add(ambientLightMain);
            
            const mainLight = new THREE.SpotLight(0xffffff, 2.0);
            mainLight.position.set(0, 15, 0); mainLight.angle = Math.PI / 3; mainLight.penumbra = 0.6; mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 1024; mainLight.shadow.mapSize.height = 1024;
            scene.add(mainLight);

            spotLightA = new THREE.SpotLight(0x4ade80, 0); 
            spotLightA.position.set(-5, 10, 0); spotLightA.angle = 0.2; spotLightA.penumbra = 0.5;
            scene.add(spotLightA);

            spotLightB = new THREE.SpotLight(0xf87171, 0); 
            spotLightB.position.set(5, 10, 0); spotLightB.angle = 0.2; spotLightB.penumbra = 0.5;
            scene.add(spotLightB);
            
            buildBoxingRing();
            buildBleachers();
            updateSponsorTextures(); 
        }

        function buildBleachers() {
            const bleacherMat = new THREE.MeshStandardMaterial({ color: 0x1a1a24, roughness: 0.9 });
            const sides = [ { rot: 0 }, { rot: Math.PI }, { rot: Math.PI/2 }, { rot: -Math.PI/2 } ];

            sides.forEach((side, index) => {
                const group = new THREE.Group();
                for(let i=0; i<4; i++) { 
                    const h = 0.6; const w = 14; const d = 1.5; 
                    const stepY = (i * h); const stepZ = 5.5 + (i * d); const boxH = stepY + h;
                    const rowGeo = new THREE.BoxGeometry(w, boxH, d);
                    const rowMesh = new THREE.Mesh(rowGeo, bleacherMat);
                    rowMesh.position.set(0, boxH/2 - 0.25, stepZ); 
                    rowMesh.receiveShadow = true; rowMesh.castShadow = true;
                    group.add(rowMesh);
                }
                group.rotation.y = side.rot;
                scene.add(group);
            });

            sponsorMaterials.videotron = new THREE.MeshBasicMaterial({ color: 0x050505 });
            const videoGeo = new THREE.PlaneGeometry(16, 9);
            const videotron = new THREE.Mesh(videoGeo, sponsorMaterials.videotron);
            videotron.position.set(0, 9, -13.01); 
            
            const frameGeo = new THREE.BoxGeometry(16.5, 9.5, 0.5);
            const frame = new THREE.Mesh(frameGeo, new THREE.MeshStandardMaterial({color: 0x111111}));
            frame.position.set(0, 9, -13.26);
            
            scene.add(videotron); scene.add(frame);
        }

        function buildBoxingRing() {
            const ringGroup = new THREE.Group();
            const ground = new THREE.Mesh(new THREE.CylinderGeometry(15, 15, 0.5, 32), new THREE.MeshStandardMaterial({ color: 0x1f3b2b, roughness: 1 }));
            ground.position.y = -0.25; ground.receiveShadow = true; scene.add(ground);

            const floor = new THREE.Mesh(new THREE.BoxGeometry(6, 0.8, 6), new THREE.MeshStandardMaterial({ color: 0x8a0b0b, roughness: 0.9 }));
            floor.receiveShadow = true; floor.position.y = 0.4; ringGroup.add(floor);

            sponsorMaterials.banner1 = new THREE.MeshBasicMaterial({ color: 0x222222 }); sponsorMaterials.banner2 = new THREE.MeshBasicMaterial({ color: 0x222222 });
            sponsorMaterials.banner3 = new THREE.MeshBasicMaterial({ color: 0x222222 }); sponsorMaterials.banner4 = new THREE.MeshBasicMaterial({ color: 0x222222 });
            const planeGeo = new THREE.PlaneGeometry(6, 0.8);
            const ban1 = new THREE.Mesh(planeGeo, sponsorMaterials.banner1); ban1.position.set(0, 0.4, 3.01); ringGroup.add(ban1);
            const ban2 = new THREE.Mesh(planeGeo, sponsorMaterials.banner2); ban2.position.set(0, 0.4, -3.01); ban2.rotation.y = Math.PI; ringGroup.add(ban2);
            const ban3 = new THREE.Mesh(planeGeo, sponsorMaterials.banner3); ban3.position.set(-3.01, 0.4, 0); ban3.rotation.y = -Math.PI/2; ringGroup.add(ban3);
            const ban4 = new THREE.Mesh(planeGeo, sponsorMaterials.banner4); ban4.position.set(3.01, 0.4, 0); ban4.rotation.y = Math.PI/2; ringGroup.add(ban4);

            sponsorMaterials.jumbotron = new THREE.MeshBasicMaterial({ color: 0x111111 });
            const jumboGroup = new THREE.Group(); jumboGroup.position.set(0, 6, 0);
            const jumboGeo = new THREE.PlaneGeometry(4, 2);
            
            const j1 = new THREE.Mesh(jumboGeo, sponsorMaterials.jumbotron); j1.position.set(0, 0, 2.01); jumboGroup.add(j1);
            const j2 = new THREE.Mesh(jumboGeo, sponsorMaterials.jumbotron); j2.position.set(0, 0, -2.01); j2.rotation.y = Math.PI; jumboGroup.add(j2);
            const j3 = new THREE.Mesh(jumboGeo, sponsorMaterials.jumbotron); j3.position.set(-2.01, 0, 0); j3.rotation.y = -Math.PI/2; jumboGroup.add(j3);
            const j4 = new THREE.Mesh(jumboGeo, sponsorMaterials.jumbotron); j4.position.set(2.01, 0, 0); j4.rotation.y = Math.PI/2; jumboGroup.add(j4);
            const jumboCover = new THREE.Mesh(new THREE.BoxGeometry(4, 2.05, 4), new THREE.MeshStandardMaterial({ color: 0x0a0a0a })); jumboGroup.add(jumboCover); scene.add(jumboGroup);

            const positions = [ [-2.8, -2.8], [2.8, -2.8], [-2.8, 2.8], [2.8, 2.8] ];
            positions.forEach(pos => { const post = new THREE.Mesh(new THREE.CylinderGeometry(0.12, 0.12, 2.5), new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.8 })); post.position.set(pos[0], 1.6, pos[1]); post.castShadow = true; ringGroup.add(post); });
            const ropeMat = new THREE.MeshStandardMaterial({ color: 0xeeeeee });
            const addRope = (x, z, rotY, yHeight) => { const rope = new THREE.Mesh(new THREE.CylinderGeometry(0.04, 0.04, 5.6), ropeMat); rope.position.set(x, yHeight, z); rope.rotation.z = Math.PI / 2; rope.rotation.y = rotY; ringGroup.add(rope); };
            [1.5, 2.2].forEach(yPos => { addRope(0, 2.8, 0, yPos); addRope(0, -2.8, 0, yPos); addRope(2.8, 0, Math.PI/2, yPos); addRope(-2.8, 0, Math.PI/2, yPos); });
            scene.add(ringGroup);
        }

        function updateSponsorTextures() {
            const data = JSON.parse(localStorage.getItem('voxel_sponsors_data') || '{}');
            for(let key in sponsorMaterials) {
                if(data[key]) {
                    const img = new Image(); img.src = data[key];
                    img.onload = () => { const tex = new THREE.Texture(img); tex.needsUpdate = true; sponsorMaterials[key].map = tex; sponsorMaterials[key].color.setHex(0xffffff); sponsorMaterials[key].needsUpdate = true; }
                } else { sponsorMaterials[key].map = null; sponsorMaterials[key].color.setHex(key === 'jumbotron' ? 0x111111 : (key === 'videotron' ? 0x050505 : 0x222222)); sponsorMaterials[key].needsUpdate = true; }
            }
        }

        function updateNameTag(sprite, name, gifts, likes) {
            const canvas = sprite.material.map.image; const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let isFighter = false; let hpPct = 100;
            if (isFighting && name === fighterA) { isFighter = true; hpPct = hpA; }
            if (isFighting && name === fighterB) { isFighter = true; hpPct = hpB; }

            ctx.fillStyle = name === currentKing ? 'rgba(200, 150, 0, 0.8)' : 'rgba(0, 0, 0, 0.7)'; 
            const boxHeight = isFighter ? 85 : 65; 

            if(ctx.roundRect) { ctx.roundRect(10, 10, 236, boxHeight, 10); } else { ctx.fillRect(10, 10, 236, boxHeight); } 
            ctx.fill();
            
            ctx.font = 'bold 22px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; 
            ctx.fillText(name === currentKing ? `üëë ${name}` : name, 128, 30);

            ctx.font = 'bold 14px Arial'; ctx.fillStyle = name === currentKing ? 'white' : '#ffcccc';
            
            let tg = Math.max(1, CONFIG.targetGifts); let tl = Math.max(1, CONFIG.targetLikes);
            let currentGifts = gifts % tg; 
            let currentLikes = likes % tl;
            ctx.fillText(`üåπ ${currentGifts}/${tg}  |  ‚ù§Ô∏è ${currentLikes}/${tl}`, 128, 55);

            if (isFighter) {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.3)'; 
                if(ctx.roundRect) { ctx.beginPath(); ctx.roundRect(38, 70, 180, 12, 6); ctx.fill(); } else { ctx.fillRect(38, 70, 180, 12); }
                
                const hpWidth = 180 * (Math.max(0, hpPct) / 100);
                ctx.fillStyle = hpPct > 50 ? '#4ade80' : hpPct > 20 ? '#facc15' : '#ef4444';
                if(ctx.roundRect && hpWidth > 0) { ctx.beginPath(); ctx.roundRect(38, 70, hpWidth, 12, 6); ctx.fill(); } else { ctx.fillRect(38, 70, hpWidth, 12); }
                
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)'; ctx.lineWidth = 1.5;
                if(ctx.roundRect) { ctx.beginPath(); ctx.roundRect(38, 70, 180, 12, 6); ctx.stroke(); } else { ctx.strokeRect(38, 70, 180, 12); }
            }

            sprite.material.map.needsUpdate = true;
        }

        function createNameTag(name, gifts, likes) {
            const canvas = document.createElement('canvas'); canvas.width = 256; canvas.height = 100; 
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas), depthTest: false }));
            sprite.scale.set(1.8, 0.7, 1); updateNameTag(sprite, name, gifts, likes); return sprite;
        }

        function createCharacterMesh(rank, name, gifts, likes) {
            const group = new THREE.Group();
            const skinMat = new THREE.MeshStandardMaterial({ color: 0xffccaa, roughness: 0.7 }); const clothesMat = new THREE.MeshStandardMaterial({ color: rank.color, roughness: 0.8 }); 
            const darkMat = new THREE.MeshStandardMaterial({ color: 0x222222 }); const gloveMat = new THREE.MeshStandardMaterial({ color: 0xd32f2f, roughness: 0.5 }); 
            const createM = (geo, mat) => { const m = new THREE.Mesh(geo, mat); m.castShadow = true; m.receiveShadow = true; return m; };

            const head = createM(new THREE.BoxGeometry(0.5, 0.5, 0.5), skinMat); head.position.y = 1.05; 
            const eyeL = createM(new THREE.BoxGeometry(0.08, 0.08, 0.05), darkMat); eyeL.position.set(-0.12, 0.05, 0.26); head.add(eyeL);
            const eyeR = createM(new THREE.BoxGeometry(0.08, 0.08, 0.05), darkMat); eyeR.position.set(0.12, 0.05, 0.26); head.add(eyeR);
            const crown = createM(new THREE.BoxGeometry(0.55, 0.2, 0.55), new THREE.MeshStandardMaterial({ color: 0xFFD700 })); crown.position.y = 0.35; crown.visible = false; head.add(crown); group.add(head);

            const body = createM(new THREE.BoxGeometry(0.5, 0.6, 0.25), clothesMat); body.position.y = 0.5; 
            const wingMat = new THREE.MeshStandardMaterial({ color: 0xFFFFFF, transparent: true, opacity: 0.9 });
            const wingL = createM(new THREE.BoxGeometry(0.8, 0.3, 0.05), wingMat); wingL.position.set(-0.5, 0.2, -0.15); wingL.visible = false;
            const wingR = createM(new THREE.BoxGeometry(0.8, 0.3, 0.05), wingMat); wingR.position.set(0.5, 0.2, -0.15); wingR.visible = false;
            body.add(wingL); body.add(wingR); group.add(body);

            const createLimb = (isArm, isLeft) => {
                const rootPivot = new THREE.Group(); const limbMat = isArm ? skinMat : darkMat; 
                const upperMesh = createM(new THREE.BoxGeometry(0.2, 0.3, 0.2), limbMat); upperMesh.position.y = -0.15; rootPivot.add(upperMesh);
                const jointPivot = new THREE.Group(); jointPivot.position.y = -0.3; rootPivot.add(jointPivot);
                const lowerMesh = createM(new THREE.BoxGeometry(0.2, 0.3, 0.2), limbMat); lowerMesh.position.y = -0.15; jointPivot.add(lowerMesh);
                if (isArm) { rootPivot.position.set(isLeft ? -0.35 : 0.35, 0.8, 0); const glove = createM(new THREE.BoxGeometry(0.25, 0.25, 0.25), gloveMat); glove.position.y = -0.15; lowerMesh.add(glove); } 
                else { rootPivot.position.set(isLeft ? -0.15 : 0.15, 0.3, 0); } return { root: rootPivot, joint: jointPivot };
            };

            const armL = createLimb(true, true); group.add(armL.root); const armR = createLimb(true, false); group.add(armR.root);
            const legL = createLimb(false, true); group.add(legL.root); const legR = createLimb(false, false); group.add(legR.root);
            
            const nameSprite = createNameTag(name, gifts, likes); nameSprite.position.y = 1.8; group.add(nameSprite);

            const side = Math.floor(Math.random() * 4); const row = Math.floor(Math.random() * 4); const posAlongRow = (Math.random() - 0.5) * 13; 
            let seatX = 0, seatZ = 0; const depth = 5.5 + (row * 1.5) - 0.2; const height = (row * 0.6) + 0.45; 
            if (side === 0) { seatX = posAlongRow; seatZ = depth; } else if (side === 1) { seatX = posAlongRow; seatZ = -depth; } else if (side === 2) { seatX = depth; seatZ = posAlongRow; } else if (side === 3) { seatX = -depth; seatZ = posAlongRow; }

            group.userData = { targetPos: new THREE.Vector3(), clothesMat: clothesMat, head: head, armL: armL.root, elbowL: armL.joint, armR: armR.root, elbowR: armR.joint, legL: legL.root, kneeL: legL.joint, legR: legR.root, kneeR: legR.joint, crown: crown, wingL: wingL, wingR: wingR, nameSprite: nameSprite, idlePos: new THREE.Vector3(seatX, height, seatZ), punched1: false, punched2: false }; return group;
        }

        function updateAudiencePositions() {
            // BATASAN MAKSIMAL 30 KARAKTER
            const userNames = Object.keys(usersData).slice(0, MAX_AUDIENCE); 
            
            // Hapus mesh jika user sudah keluar dari top 30
            for (const name in characterMeshes) { 
                if (!userNames.includes(name)) { 
                    if (isFighting && (name === fighterA || name === fighterB)) continue; 
                    scene.remove(characterMeshes[name]); 
                    delete characterMeshes[name]; 
                } 
            }

            // Tambahkan atau update mesh untuk 30 user teratas
            userNames.forEach((name) => {
                const userData = usersData[name]; const rank = getRank(userData.gifts);
                if (!characterMeshes[name]) { 
                    const mesh = createCharacterMesh(rank, name, userData.gifts || 0, userData.likes || 0); 
                    mesh.position.set(0, 10, 0); 
                    scene.add(mesh); 
                    characterMeshes[name] = mesh; 
                } else { 
                    const ud = characterMeshes[name].userData; 
                    ud.clothesMat.color.setHex(rank.color); 
                    ud.crown.visible = rank.tier >= 4 || name === currentKing; 
                    ud.wingL.visible = rank.tier >= 5; ud.wingR.visible = rank.tier >= 5; 
                }
                
                const ud = characterMeshes[name].userData;
                if (isFighting && (name === fighterA || name === fighterB)) return; 
                if (name === currentKing && !isFighting) { ud.targetPos.set(0, 1.1, 0); } else { ud.targetPos.copy(ud.idlePos); }
            });
        }

        let clock = new THREE.Clock(); const lerpRot = (obj, targetX, targetZ = 0, speed = 0.2) => { if (!obj) return; obj.rotation.x += (targetX - obj.rotation.x) * speed; obj.rotation.z += (targetZ - obj.rotation.z) * speed; };

        function animate() {
            requestAnimationFrame(animate); const time = clock.getElapsedTime(); const delta = clock.getDelta();

            particles.forEach((p, i) => {
                p.position.x += p.userData.vx; p.position.y += p.userData.vy; p.position.z += p.userData.vz;
                p.userData.vy -= 0.01; p.userData.life -= 0.03; p.scale.setScalar(p.userData.life);
                if(p.userData.life <= 0) { scene.remove(p); particles.splice(i, 1); }
            });

            if (!isFighting) {
                const t = time * 0.1; targetCamPos.set(Math.sin(t) * 12 + Math.sin(t * 0.4) * 4, 10 + Math.sin(t * 0.3) * 4, Math.cos(t) * 12 + Math.cos(t * 0.5) * 4); targetLookAt.set(Math.sin(t*0.5)*3, 2, Math.cos(t*0.7)*3); 
            } else {
                const ft = fightTimer * 0.4; targetCamPos.set(Math.sin(ft * 0.5) * 8, 3 + Math.abs(Math.sin(ft * 0.3)) * 3, Math.cos(ft * 0.5) * 8); targetLookAt.set(0, 1.5, 0); 
                if(spotLightA && characterMeshes[fighterA]) spotLightA.target = characterMeshes[fighterA].userData.head;
                if(spotLightB && characterMeshes[fighterB]) spotLightB.target = characterMeshes[fighterB].userData.head;
            }

            camera.position.lerp(targetCamPos, 0.015); currentLookAt.lerp(targetLookAt, 0.03); camera.lookAt(currentLookAt);
            if (isFighting) fightTimer += 0.016; 

            let endFightThisFrame = false;

            for (const name in characterMeshes) {
                const mesh = characterMeshes[name]; const ud = mesh.userData; ud.nameSprite.lookAt(camera.position); 
                if (ud.wingL.visible) { ud.wingL.rotation.y = -0.3 + Math.sin(time * 6) * 0.4; ud.wingR.rotation.y = 0.3 - Math.sin(time * 6) * 0.4; }
                let tArmL_X = 0, tArmL_Z = 0, tArmR_X = 0, tArmR_Z = 0, tElbowL_X = -0.1, tElbowR_X = -0.1, tLegL_X = 0, tLegR_X = 0, tKneeL_X = 0, tKneeR_X = 0, tHead_Y = 0;

                if (isFighting && (name === fighterA || name === fighterB)) {
                    if (fightPhase === 0) {
                        if (name === fighterA) ud.targetPos.set(-1.5, 1.1, 0); if (name === fighterB) ud.targetPos.set(1.5, 1.1, 0);
                        const speed = time * 20; tArmL_X = Math.sin(speed) * 0.8; tElbowL_X = -0.2; tArmR_X = -Math.sin(speed) * 0.8; tElbowR_X = -0.2; tLegL_X = -Math.sin(speed) * 0.8; tKneeL_X = tLegL_X < 0 ? Math.abs(tLegL_X) : 0; tLegR_X = Math.sin(speed) * 0.8; tKneeR_X = tLegR_X < 0 ? Math.abs(tLegR_X) : 0;
                        if (fightTimer > 2.5) { fightPhase = 1; fightTimer = 0; }
                    } 
                    else if (fightPhase === 1) {
                        const angle = fightTimer * 1.5; const radius = 1.0 + Math.sin(fightTimer * 3) * 0.4; const cx = Math.sin(fightTimer) * 0.8; const cz = Math.cos(fightTimer * 1.3) * 0.8;
                        if (name === fighterA) ud.targetPos.set(cx + Math.cos(angle)*radius, 1.1, cz + Math.sin(angle)*radius); if (name === fighterB) ud.targetPos.set(cx + Math.cos(angle + Math.PI)*radius, 1.1, cz + Math.sin(angle + Math.PI)*radius);
                        const opponent = name === fighterA ? characterMeshes[fighterB] : characterMeshes[fighterA]; if(opponent) mesh.lookAt(opponent.position.x, mesh.position.y, opponent.position.z);

                        tLegL_X = -0.2; tKneeL_X = 0.3; tLegR_X = 0.3; tKneeR_X = 0.3;
                        const isAttacker = (Math.floor(fightTimer / 1.5) % 2 === 0) ? (name === fighterA) : (name === fighterB); const punchCycle = (fightTimer * 8) % 4; 

                        // PENGURANGAN DAMAGE (Dari CONFIG SERVER)
                        if (isAttacker) {
                            if (punchCycle < 1) { 
                                tArmL_X = -Math.PI/2.2; tElbowL_X = 0; tArmR_X = -Math.PI/4; tElbowR_X = -Math.PI/1.5; 
                                if (punchCycle > 0.8 && !ud.punched1) { 
                                    ud.punched1 = true;
                                    playPunchSound(); createHitSparks(opponent.position); 
                                    
                                    let dmg = CONFIG.damagePower || 1;
                                    if(name === fighterA) { hpB -= dmg; } else { hpA -= dmg; } 
                                    
                                    if(characterMeshes[fighterA]) updateNameTag(characterMeshes[fighterA].userData.nameSprite, fighterA, usersData[fighterA].gifts, usersData[fighterA].likes);
                                    if(characterMeshes[fighterB]) updateNameTag(characterMeshes[fighterB].userData.nameSprite, fighterB, usersData[fighterB].gifts, usersData[fighterB].likes);
                                } 
                            } 
                            else if (punchCycle < 2) { 
                                tArmL_X = -Math.PI/4; tElbowL_X = -Math.PI/1.5; tArmR_X = -Math.PI/4; tElbowR_X = -Math.PI/1.5; 
                                ud.punched1 = false; 
                            } 
                            else if (punchCycle < 3) { 
                                tArmL_X = -Math.PI/4; tElbowL_X = -Math.PI/1.5; tArmR_X = -Math.PI/1.2; tElbowR_X = -Math.PI/2.5; tArmR_Z = Math.PI/6; mesh.position.y = 1.3; 
                                if (punchCycle > 2.8 && !ud.punched2) { 
                                    ud.punched2 = true;
                                    playPunchSound(); createHitSparks(opponent.position); 
                                    
                                    let heavyDmg = (CONFIG.damagePower || 1) * 2;
                                    if(name === fighterA) { hpB -= heavyDmg; } else { hpA -= heavyDmg; } 
                                    
                                    if(characterMeshes[fighterA]) updateNameTag(characterMeshes[fighterA].userData.nameSprite, fighterA, usersData[fighterA].gifts, usersData[fighterA].likes);
                                    if(characterMeshes[fighterB]) updateNameTag(characterMeshes[fighterB].userData.nameSprite, fighterB, usersData[fighterB].gifts, usersData[fighterB].likes);
                                } 
                            } 
                            else { 
                                tArmL_X = -Math.PI/4; tElbowL_X = -Math.PI/1.5; tArmR_X = -Math.PI/4; tElbowR_X = -Math.PI/1.5; 
                                ud.punched2 = false; 
                            }
                        } else {
                            tArmL_X = -Math.PI/3; tElbowL_X = -Math.PI/1.3; tArmL_Z = Math.PI/8; tArmR_X = -Math.PI/3; tElbowR_X = -Math.PI/1.3; tArmR_Z = -Math.PI/8; tHead_Y = Math.sin(fightTimer * 15) * 0.3; 
                            ud.punched1 = false; ud.punched2 = false;
                        }
                        
                        if (hpA <= 0 || hpB <= 0 || fightTimer >= 30) { processMatchResult(); } 
                    }
                    else if (fightPhase === 2) {
                        if (name === matchLoser) { ud.targetPos.y = 0.95; mesh.rotation.x += (-Math.PI/2 - mesh.rotation.x) * 0.1; tArmL_X = Math.PI; tElbowL_X = -0.2; tArmR_X = Math.PI; tElbowR_X = -0.2; tLegL_X = 0; tKneeL_X = 0.3; } 
                        else if (name === matchWinner) { ud.targetPos.y = 1.1 + Math.abs(Math.sin(fightTimer * 8)) * 1.5; mesh.rotation.y += 0.15; tArmL_X = Math.PI; tElbowL_X = -0.1; tArmR_X = Math.PI; tElbowR_X = -0.1; }
                        if (fightTimer > 4) { 
                            mesh.rotation.x = 0;
                            endFightThisFrame = true;
                        }
                    }
                    mesh.position.lerp(ud.targetPos, 0.1); 
                } 
                else if (name === currentKing && !isFighting) {
                    mesh.position.lerp(ud.targetPos, 0.05); mesh.lookAt(0, 1.5, 5); 
                    mesh.position.y = ud.targetPos.y; 
                    
                    tArmL_X = -0.2; tArmL_Z = 0.5; tElbowL_X = -1.5; tArmR_X = -0.2; tArmR_Z = -0.5; tElbowR_X = -1.5; tLegL_X = -0.1; tLegR_X = 0.1; tHead_Y = Math.sin(time) * 0.5; 
                }
                else {
                    // DUDUK DI TRIBUN
                    mesh.position.lerp(ud.targetPos, 0.05); 
                    mesh.lookAt(0, ud.targetPos.y, 0); 
                    
                    if (mesh.position.distanceTo(ud.targetPos) > 0.5) {
                        const speed = time * 15; tArmL_X = Math.sin(speed) * 0.6; tElbowL_X = -0.2; tArmR_X = -Math.sin(speed) * 0.6; tElbowR_X = -0.2;
                        tLegL_X = -Math.sin(speed) * 0.6; tKneeL_X = tLegL_X < 0 ? Math.abs(tLegL_X) : 0; tLegR_X = Math.sin(speed) * 0.6;  tKneeR_X = tLegR_X < 0 ? Math.abs(tLegR_X) : 0;
                    } else {
                        mesh.position.y = ud.targetPos.y; 
                        
                        tLegL_X = -Math.PI / 2.2; tKneeL_X = Math.PI / 2.2;
                        tLegR_X = -Math.PI / 2.2; tKneeR_X = Math.PI / 2.2;

                        tArmL_X = Math.sin(time * 2 + mesh.position.x) * 0.05; tArmR_X = Math.cos(time * 2 + mesh.position.z) * 0.05; tElbowL_X = -0.1; tElbowR_X = -0.1; tHead_Y = Math.sin(time * 1.5 + mesh.position.z) * 0.15; 
                    }
                }

                lerpRot(ud.armL, tArmL_X, tArmL_Z); lerpRot(ud.elbowL, tElbowL_X); lerpRot(ud.armR, tArmR_X, tArmR_Z); lerpRot(ud.elbowR, tElbowR_X);
                lerpRot(ud.legL, tLegL_X); lerpRot(ud.kneeL, tKneeL_X); lerpRot(ud.legR, tLegR_X); lerpRot(ud.kneeR, tKneeR_X);
                ud.head.rotation.y += (tHead_Y - ud.head.rotation.y) * 0.2;
            }

            if (endFightThisFrame) {
                isFighting = false; fighterA = null; fighterB = null; 
                const winnerOverlay = document.getElementById('winner-overlay'); winnerOverlay.classList.add('opacity-0'); setTimeout(() => { winnerOverlay.classList.add('hidden'); }, 500);
                
                if (fightQueue.length === 0) setArenaStatus(`üëë Raja ${currentKing} Menunggu Penantang`, "text-yellow-400 bg-yellow-900/30 border-yellow-500");
                updateAudiencePositions(); 
                isDataDirty = true; 
            }

            renderer.render(scene, camera);
        }

        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
    </script>
</body>
</html>